# FINT Kafka Project
[![CI](https://github.com/FINTLabs/fint-kafka/actions/workflows/ci.yaml/badge.svg)](https://github.com/FINTLabs/fint-kafka/actions/workflows/ci.yaml)

This library implements the Kafka patterns that we use in FINT:
* Entity
* Event
* Request/reply

It also has services to help ensure that all necessary topics is created and configured correctly.

## Topics
Topic names and name patterns are generated by creating parameter classes. These parameter classes are accepted as arguments for the services that prove topic functionality, such as creating and configuring topics, getting topic information and configurations, and producing and consuming messages. When the parameter objects are passed to one of the services that accept them, they are internally mapped to topic names or topic name patterns that follow the FINT topic standards.

OrgId and domain context are automatically added as prefixes to the topic names and patterns. The values that are used for these topic components are defined by the application properties 'fint.kafka.topic.org-id' and 'fint.kafka.topic.domain-context'.
domain-context: test-domain-context

### Creating topic name parameters
Topic names are generated with the following implementations of the ``TopicNameParameters`` interface:
* ``EntityTopicNameParameters``
* ``EventTopicNameParameters``
* ``ErrorEventTopicNameParameters``
* ``RequestTopicNameParameters``
* ``ReplyTopicNameParameters``

### Creating topic name pattern parameters
Topic name patterns are generated with the following implementation of the ``TopicNamePatternParameters`` interface:
* ``EntityTopicNamePatternParameters``
* ``EventTopicNamePatternParameters``
* ``ErrorEventTopicNamePatternParameters``
* ``RequestTopicNamePatternParameters``
* ``ReplyTopicNamePatternParameters``

### Examples

#### Entity
```java
EntityTopicNameParameters
        .builder()
        .resource("arkiv.noark.administrativenhet")
        .build()
// Result: <orgId>.<domain-context>.entity.arkiv.noark.administrativenhet
```

#### Event
```java
EventTopicNameParameters
          .builder()
          .eventName("adapter-health")
          .build()
// Result: <orgId>.<domain-context>.event.adapter-health
```

#### Error event
```java
ErrorEventTopicNameParameters
          .builder()
          .errorEventName("instance-processing-error")
          .build()
// Result: <orgId>.<domain-context>.event.error.instance-processing-error
```

#### Request
```java
RequestTopicNameParameters
        .builder()
        .resource("arkiv.noark.sak")
        .parameterName("mappeid")
        .build()
// Result: <orgId>.<domain-context>.request.arkiv.noark.sak.by.mappeid
```

#### Reply
```java
ReplyTopicNameParameters
        .builder()
        .applicationId(applicationId)
        .resource("arkiv.noark.sak")
        .build()
// Result: <orgId>.<domain-context>.reply.<applicationId>.arkiv.noark.sak
```

  
### Ensuring topic creation and configuration
Ensuring topics are created and with a given configuration is done with the following services:
* ``EntityTopicService``
* ``EventTopicService``
* ``ErrorEventTopicService``
* ``RequestTopicService``
* ``ReplyTopicService``

#### Entity
It is the responsibility of the service that **produces** the entities to ensure that the topic is created and has the correct configuration.

##### Example
```java
entityTopicService.ensureTopic(
        entityTopicNameParameters,
        retentionTimeMs
);
```

#### Event
It is the responsibility of the service that **produces** the events to ensure that the topic is created and has the correct configuration.

##### Example
```java
eventTopicService.ensureTopic(
        eventTopicNameParameters,
        retentionTimeMs
);
```

#### Error event
It is the responsibility of the service that **produces** the events to ensure that the topic is created and has the correct configuration.

##### Example
```java
errorEventTopicService.ensureTopic(
        eventTopicNameParameters,
        retentionTimeMs
);
```

#### Request
For the request topic, it is the responsibility of the service that **consumes** the requests to ensure that the topic is created and has the correct configuration.

##### Example
```java
requestTopicService.ensureTopic(
        requestTopicNameParameters,
        retentionTimeMs
);
```

#### Reply
For the reply topic, it is the responsibility of the service that **produces** the requests to ensure that the topic is created and has the correct configuration.

##### Example
```java
replyTopicService.ensureTopic(
        replyTopicNameParameters,
        retentionTimeMs
);
```

## Producers
There is a specialized producer for each of the message patterns in the kafka implementation. These producers are created through producer factories, with the exception of the error event producer, which is autowired directly.

Following are the producer factories and producers that the fint kafka library supplies: 
* ``EntityProducerFactory`` -> ``EntityProducer<T>``
* ``EventProducerFactory`` -> ``EventProducer<T>``
* ``ErrorEventProducer`` (autowired directly)
* ``RequestProducerFactory`` -> ``RequestProducer<V, R>``

### Examples
#### Entity
```java
@Autowired EntityProducerFactory entityProducerFactory;

entityProducerFactory.createProducer(Object.class);
```

#### Event
```java
@Autowired EventProducerFactory eventProducerFactory;

eventProducerFactory.createProducer(SakResource.class)
```

#### Event
```java
@Autowired ErrorEventProducer errorEventProducer;
```

#### Request
```java
@Autowired RequestProducerFactory requestProducerFactory;

requestProducerFactory.createProducer(
                ReplyTopicNameParameters.builder().applicationId(applicationId).resource("arkiv.noark.sak").build(),
                String.class,
                SakResource.class
);
```


## Consumers
Consumers are created with the ``EntityConsumerFactoryService``, ``EventConsumerFactoryService``, ``ErrorEventConsumerFactoryService`` and ``RequestConsumerFactoryService``. These factory services create an instance of ``ListenerContainerFactory<VALUE, TOPIC_NAME_PARAMETERS, TOPIC_NAME_PATTERN_PARAMETERS>`` which is configured to accept only the appropriate topic name parameters for the respective kafka message pattern. The listener container is then created by passing either topic name parameters or topic name pattern parameters to the ``ListenerContainerFactory``.

**NB:** The ``ConcurrentMessageListenerContainer<K, V>`` that is created by the ``ListenerContainerFactory`` has to be registered in the Spring context to be picked up by the Apache Kafka library. This is usually done by creating and returning the consumer in a @Bean annotated method in a configuration class, but can also be done through the ``ListenerBeanRegistrationService``.

### Error handling
Error handling is done with an optional parameter for the creation methods in the factories, which accepts implementations of the ``CommonErrorHandler`` interface. For simple logging of encountered errors, the ``CommonLoggingErrorHandler``can be used.


### Examples
#### Entity
```java
@Autowired EntityConsumerFactoryService entityConsumerFactoryService;

entityConsumerFactoryService.createFactory(
        AdministrativEnhetResource.class,
        consumerRecord -> processEntity(consumerRecord.value()),
        new CommonLoggingErrorHandler()
).createContainer(
        EntityTopicNameParameters
            .builder()
            .resource("arkiv.noark.administrativenhet")
            .build()
);

```
#### Event
```java
@Autowired EventConsumerFactoryService eventConsumerFactoryService;

eventConsumerFactoryService.createFactory(
        Instance.class,
        consumerRecord -> processEvent(consumerRecord.value()),
        new CommonLoggingErrorHandler()
).createContainer(
        EventTopicNameParameters
            .builder()
            .eventName("adapter-health")
            .build()
);
```

#### Error event
```java
@Autowired ErrorEventConsumerFactoryService errorEventConsumerFactoryService;

errorEventConsumerFactoryService.createFactory(
        consumerRecord -> processErrorEvent(consumerRecord.value()),
        new CommonLoggingErrorHandler()
).createContainer(
        ErrorEventTopicNameParameters
            .builder()
            .errorEventName("instance-processing-error")
            .build()
);
```

#### Request
```java
@Autowired RequestConsumerFactoryService requestConsumerFactoryService;

requestConsumerFactoryService.createFactory(
        String.class,
        SakResource.class,
        (consumerRecord) -> createReplyProducerRecord(consumerRecord),
        new CommonLoggingErrorHandler()
).createContainer(
        RequestTopicNameParameters
            .builder()
            .resource("arkiv.noark.sak")
            .parameterName("mappeid")
            .build()
        );
```

## Debugging and logging
To change the logging level of the Apache Kafka library, use the following property in the application properties:
```
logging:
  level:
    org.apache.kafka: INFO
```
