# FINT Kafka Project
[![CI](https://github.com/FINTLabs/fint-kafka/actions/workflows/ci.yaml/badge.svg)](https://github.com/FINTLabs/fint-kafka/actions/workflows/ci.yaml)

This library implements the Kafka patterns that we use in FINT:
* Entity
* Event
* Request/reply

It also has services to help ensure that all necessary topics is created and configured correctly.


## Topics
Topic names and name patterns are generated by creating parameter classes. These parameter classes are accepted as arguments for the services that provide topic functionality, such as creating and configuring topics, getting topic information and configurations, and producing and consuming messages. When the parameter objects are passed to one of the services that accept them, they are internally mapped to topic names or topic name patterns that follow the FINT topic standards.

### Creating topic name parameters
Topic names are generated with the following implementations of the ``TopicNameParameters`` interface:
* ``EntityTopicNameParameters``
* ``EventTopicNameParameters``
* ``ErrorEventTopicNameParameters``
* ``RequestTopicNameParameters``
* ``ReplyTopicNameParameters``

#### OrgId & domainContext
OrgId and domainContext are used in all topic names and patterns, as the first and second component respectively. They can be configured in two separate ways: through application properties and by supplying them to a topicName or topicNamePattern builder. If set as application properties, the values are used as default values, and are included in the topic name or pattern if no other value is provided in the builder.

##### The application properties used for orgId and domainContext
* ``fint.kafka.topic.org-id`` - Used as the first component in generated topic names
* ``fint.kafka.topic.domain-context`` - Used as the second component in generated topic names

#### Examples

##### Entity
```java
EntityTopicNameParameters
        .builder()
        .orgId("fint.no")       // Optional if set as application property
        .domainContext("flyt")  // Optional if set as application property
        .resource("arkiv.noark.administrativenhet")
        .build()
// Result: fint-no.flyt.entity.arkiv.noark.administrativenhet
```

#### Event
```java
EventTopicNameParameters
        .builder()
        .orgId("fint.no")       // Optional if set as application property
        .domainContext("flyt")  // Optional if set as application property
        .eventName("adapter-health")
        .build()
// Result: fint-no.flyt.event.adapter-health
```

#### Error event
```java
ErrorEventTopicNameParameters
        .builder()
        .orgId("fint.no")       // Optional if set as application property
        .domainContext("flyt")  // Optional if set as application property
        .errorEventName("instance-processing-error")
        .build()
// Result: fint-no.flyt.event.error.instance-processing-error
```

#### Request
```java
RequestTopicNameParameters
        .builder()
        .orgId("fint.no")       // Optional if set as application property
        .domainContext("flyt")  // Optional if set as application property
        .resource("arkiv.noark.sak")
        .parameterName("mappeid")
        .build()
// Result: fint-no.flyt.request.arkiv.noark.sak.by.mappeid
```

#### Reply
```java
ReplyTopicNameParameters
        .builder()
        .orgId("fint.no")       // Optional if set as application property
        .domainContext("flyt")  // Optional if set as application property
        .applicationId(applicationId)
        .resource("arkiv.noark.sak")
        .build()
// Result: fint-no.flyt.reply.<applicationId>.arkiv.noark.sak
```

### Creating topic name pattern parameters
Topic name patterns are generated with the following implementation of the ``TopicNamePatternParameters`` interface:
* ``EntityTopicNamePatternParameters``
* ``EventTopicNamePatternParameters``
* ``ErrorEventTopicNamePatternParameters``
* ``RequestTopicNamePatternParameters``
* ``ReplyTopicNamePatternParameters``

The fields of these parameter classes are boolean or implementations of either ``FormattedTopicComponentPattern`` or ``ValidatedTopicComponentPattern``. The two component pattern classes each provide the methods ``any()``, ``anyOf(String... values)`` and ``anyExcluding(String...values)``, that generate the appropriate regex matching patterns.

#### Examples

##### Entity
```java
EntityTopicNamePatternParameters
        .builder()
        .orgId(FormattedTopicComponentPattern.anyOf("fint.no"))       // Optional if set as application property
        .domainContext(FormattedTopicComponentPattern.anyOf("flyt"))  // Optional if set as application property
        .resource(FormattedTopicComponentPattern.any())
        .build()
```

#### Event
```java
EventTopicNamePatternParameters
        .builder()
        .orgId(FormattedTopicComponentPattern.anyOf("fint.no"))       // Optional if set as application property
        .domainContext(FormattedTopicComponentPattern.anyOf("flyt"))  // Optional if set as application property
        .eventName(ValidatedTopicComponentPattern.anyOf("adapter-health"))
        .build()
```

#### Error event
```java
ErrorEventTopicNamePatternParameters
        .builder()
        .orgId(FormattedTopicComponentPattern.anyOf("fint.no"))       // Optional if set as application property
        .domainContext(FormattedTopicComponentPattern.anyOf("flyt"))  // Optional if set as application property
        .errorEventName(ValidatedTopicComponentPattern.anyExcluding("instance-processing-error"))
        .build()
```

#### Request
```java
RequestTopicNamePatternParameters
        .builder()
        .orgId(FormattedTopicComponentPattern.anyOf("fint.no"))       // Optional if set as application property
        .domainContext(FormattedTopicComponentPattern.anyOf("flyt"))  // Optional if set as application property
        .resource(FormattedTopicComponentPattern.anyOf("arkiv.noark.sak"))
        .isCollection(true)
        .parameterName(ValidatedTopicComponentPattern.any())
        .build()
```

#### Reply
```java
ReplyTopicNamePatternParameters
        .builder()
        .orgId(FormattedTopicComponentPattern.anyOf("fint.no"))       // Optional if set as application property
        .domainContext(FormattedTopicComponentPattern.anyOf("flyt"))  // Optional if set as application property
        .applicationId(ValidatedTopicComponentPattern.any())
        .resource(FormattedTopicComponentPattern.anyOf("arkiv.noark.sak", "configuration"))
        .build()
```

### Ensuring topic creation and configuration
Ensuring topics are created and with a given configuration is done with the following services:
* ``EntityTopicService``
* ``EventTopicService``
* ``ErrorEventTopicService``
* ``RequestTopicService``
* ``ReplyTopicService``

#### Entity
It is the responsibility of the service that **produces** the entities to ensure that the topic is created and has the correct configuration.

##### Example
```java
@Autowired EntityTopicService entityTopicService;

entityTopicService.ensureTopic(
        entityTopicNameParameters,
        retentionTimeMs
);
```

#### Event
It is the responsibility of the service that **produces** the events to ensure that the topic is created and has the correct configuration.

##### Example
```java
@Autowired EventTopicService eventTopicService;

eventTopicService.ensureTopic(
        eventTopicNameParameters,
        retentionTimeMs
);
```

#### Error event
It is the responsibility of the service that **produces** the events to ensure that the topic is created and has the correct configuration.

##### Example
```java
@Autowired ErrorEventTopicService errorEventTopicService;

errorEventTopicService.ensureTopic(
        eventTopicNameParameters,
        retentionTimeMs
);
```

#### Request
For the request topic, it is the responsibility of the service that **consumes** the requests to ensure that the topic is created and has the correct configuration.

##### Example
```java
@Autowired RequestTopicService requestTopicService;

requestTopicService.ensureTopic(
        requestTopicNameParameters,
        retentionTimeMs
);
```

#### Reply
For the reply topic, it is the responsibility of the service that **produces** the requests to ensure that the topic is created and has the correct configuration.

##### Example
```java
@Autowired ReplyTopicService replyTopicService;

replyTopicService.ensureTopic(
        replyTopicNameParameters,
        retentionTimeMs
);
```

## Producers
There is a specialized producer for each of the message patterns in the kafka implementation. These producers are created through producer factories, with the exception of the error event producer, which is autowired directly.

Following are the producer factories and producers that the fint kafka library supplies: 
* ``EntityProducerFactory`` -> ``EntityProducer<T>``
* ``EventProducerFactory`` -> ``EventProducer<T>``
* ``ErrorEventProducer`` (autowired directly)
* ``RequestProducerFactory`` -> ``RequestProducer<V, R>``

### Examples
#### Entity
```java
@Autowired EntityProducerFactory entityProducerFactory;

entityProducerFactory.createProducer(Object.class);
```

#### Event
```java
@Autowired EventProducerFactory eventProducerFactory;

eventProducerFactory.createProducer(SakResource.class)
```

#### Error event
```java
@Autowired ErrorEventProducer errorEventProducer;
```

#### Request
```java
@Autowired RequestProducerFactory requestProducerFactory;

requestProducerFactory.createProducer(
                ReplyTopicNameParameters.builder().applicationId(applicationId).resource("arkiv.noark.sak").build(),
                String.class,
                SakResource.class
);
```


## Consumers
Consumers are created with the ``EntityConsumerFactoryService``, ``EventConsumerFactoryService``, ``ErrorEventConsumerFactoryService`` and ``RequestConsumerFactoryService``. These factory services create an instance of ``ListenerContainerFactory<VALUE, TOPIC_NAME_PARAMETERS, TOPIC_NAME_PATTERN_PARAMETERS>`` which is configured to accept only the appropriate topic name parameters for the respective kafka message pattern. The listener container is then created by passing either topic name parameters or topic name pattern parameters to the ``ListenerContainerFactory``.

**NB:** The ``ConcurrentMessageListenerContainer<K, V>`` that is created by the ``ListenerContainerFactory`` has to be registered in the Spring context to be picked up by the Apache Kafka library. This is usually done by creating and returning the consumer in a @Bean annotated method in a configuration class, but can also be done through the ``ListenerBeanRegistrationService``.

### Error handling
Error handling is done with an optional parameter for the creation methods in the factories, which accepts implementations of the ``CommonErrorHandler`` interface. For simple logging of encountered errors, the ``CommonLoggingErrorHandler``can be used.


### Examples
#### Entity
```java
@Autowired EntityConsumerFactoryService entityConsumerFactoryService;

entityConsumerFactoryService.createFactory(
        AdministrativEnhetResource.class,
        consumerRecord -> processEntity(consumerRecord.value()),
        new CommonLoggingErrorHandler()
).createContainer(
        EntityTopicNameParameters
            .builder()
            .resource("arkiv.noark.administrativenhet")
            .build()
);

```
#### Event
```java
@Autowired EventConsumerFactoryService eventConsumerFactoryService;

eventConsumerFactoryService.createFactory(
        Instance.class,
        consumerRecord -> processEvent(consumerRecord.value()),
        new CommonLoggingErrorHandler()
).createContainer(
        EventTopicNameParameters
            .builder()
            .eventName("adapter-health")
            .build()
);
```

#### Error event
```java
@Autowired ErrorEventConsumerFactoryService errorEventConsumerFactoryService;

errorEventConsumerFactoryService.createFactory(
        consumerRecord -> processErrorEvent(consumerRecord.value()),
        new CommonLoggingErrorHandler()
).createContainer(
        ErrorEventTopicNameParameters
            .builder()
            .errorEventName("instance-processing-error")
            .build()
);
```

#### Request
```java
@Autowired RequestConsumerFactoryService requestConsumerFactoryService;

requestConsumerFactoryService.createFactory(
        String.class,
        SakResource.class,
        (consumerRecord) -> createReplyProducerRecord(consumerRecord),
        new CommonLoggingErrorHandler()
).createContainer(
        RequestTopicNameParameters
            .builder()
            .resource("arkiv.noark.sak")
            .parameterName("mappeid")
            .build()
        );
```

## Debugging and logging
To change the logging level of the Apache Kafka library, use the following property in the application properties:
```
logging:
  level:
    org.apache.kafka: INFO
```

## Running with local kafka instance
When running with a local kafka instance with a single broker instance, it is required to set ``fint.kafka.default-replicas=1`` in the application properties, preferably by adding it to the environmental variables in the run configuration in the IDE.